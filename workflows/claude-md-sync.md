# GMSD Workflow: CLAUDE.md Auto-Sync Engine

This workflow regenerates the project's `.claude/CLAUDE.md` file to give Claude Code full project context without running GMSD commands. Any GMSD command that changes project state should invoke this workflow after its state update step.

---

## Instructions

### Step 1: Read All Available Project State

Read the following files from the current working directory. Not all files will exist — skip any that are missing and note which were found.

**Required files:**
- `.planning/state.json` — current phase, status, mode, version
- `.planning/config.json` — team settings, git settings, model overrides

**If `.planning/state.json` does not exist, stop.** The sync cannot run without project state. This is not an error — it simply means no project has been initialized yet.

**Optional files (read if they exist):**
- `.planning/PROJECT.md` — project name, vision, requirements, constraints
- `.planning/ROADMAP.md` — all phases with status
- `.planning/phases/{current_phase_dir}/CONTEXT.md` — active phase decisions (use `current_phase` from state.json to determine the directory; scan `.planning/phases/` for a directory starting with `{current_phase}-`)
- `.planning/phases/{current_phase_dir}/PLAN.md` — active tasks and file ownership
- `.planning/design/design-tokens.json` — key design values
- `.planning/design/COMPONENTS.md` — component inventory
- `.planning/todos.json` — open todos
- `.planning/TECH-DEBT.md` — known tech debt
- `.planning/CARRIED-CONTEXT.md` — carried-forward decisions from previous milestones

### Step 2: Extract Key Data

From the files read in Step 1, extract:

**From state.json:**
- `project` (project name)
- `version`
- `mode`
- `current_milestone`
- `current_phase`
- `phase_status`

**From PROJECT.md (if exists):**
- The vision/description paragraph (first paragraph under the Vision or Project Overview heading)
- Must-have requirements list
- Technical constraints

**From ROADMAP.md (if exists):**
- The phase list table with phase numbers, names, and statuses

**From current phase CONTEXT.md (if exists):**
- The Decisions tables (Architecture, Technology, UX/Behavior, Scope)
- Extract each decision as: Decision summary | Choice made | Brief rationale

**From current phase PLAN.md (if exists):**
- The File Ownership map (file/directory | owning task | description)
- Task list (task number, name, status if available)

**From design-tokens.json (if exists):**
- Primary color palette (just the main values, not the full scale)
- Font family
- Key spacing values
- Breakpoints

**From COMPONENTS.md (if exists):**
- Component names grouped by category, with brief usage notes

**From todos.json (if exists):**
- Open todo items, sorted by priority

**From TECH-DEBT.md (if exists):**
- Debt items sorted by severity

**From CARRIED-CONTEXT.md (if exists):**
- Key carried-forward decisions

### Step 3: Determine Current Phase Directory Name

To find the current phase's artifacts:
1. Read `current_phase` from state.json
2. If `current_phase` is null, skip phase-specific sections
3. If `current_phase` is set, scan `.planning/phases/` for a directory whose name starts with `{current_phase}-` (e.g., `3-` for phase 3)
4. Use that directory name for reading CONTEXT.md and PLAN.md

### Step 4: Generate CLAUDE.md Content

Compose the `.claude/CLAUDE.md` file using the template below. **Omit any section whose source data was not found** — do not include empty sections or placeholder text. The file should be concise and actionable.

```markdown
# {project_name} — GMSD Project Context

> Auto-generated by GMSD. Do not edit manually — changes will be overwritten on next sync.
> Last synced: {current ISO timestamp}

## Project Overview
{One paragraph extracted from PROJECT.md vision section. If PROJECT.md was not found, use the project name from state.json: "Project: {project_name}. No PROJECT.md found — run /gmsd:progress for details."}

## Current State
- **Version:** {version}
- **Mode:** {mode}
- **Milestone:** {current_milestone}
- **Phase:** {current_phase} — {phase_name from ROADMAP.md}
- **Status:** {phase_status}

## Active Decisions
{Only include if current phase CONTEXT.md exists and has decisions.}

| Decision | Choice | Rationale |
|----------|--------|-----------|
| {decision_summary} | {choice} | {rationale} |
...

These decisions are locked. Do not contradict them without running `/gmsd:discuss-phase`.

## File Ownership (Current Phase)
{Only include if current phase PLAN.md exists and has a file ownership map.}

| File / Directory | Owner Task | Description |
|------------------|------------|-------------|
| {path} | Task {N}: {name} | {description} |
...

IMPORTANT: Do not modify files owned by another task without coordination.

## Design System
{Only include if design-tokens.json or COMPONENTS.md exist.}

### Tokens
- **Primary color:** {primary color value}
- **Font:** {font family}
- **Spacing scale:** {key spacing values}
- **Breakpoints:** {breakpoint list}

### Components
{Component names grouped by category with brief usage notes}

Always use design tokens instead of hardcoded values. Reference `.planning/design/design-tokens.json` for the full token set.

## Phase Roadmap
{Only include if ROADMAP.md exists.}

| Phase | Name | Status |
|-------|------|--------|
| {N} | {name} | {status} |
...

## Open Todos
{Only include if todos.json exists and has open items. Sort by priority.}

- [ ] [{priority}] {todo description}
...

## Technical Debt
{Only include if TECH-DEBT.md exists. Sort by severity.}

| Severity | Description | Origin |
|----------|-------------|--------|
| {severity} | {description} | Phase {N} |
...

## Carried Context
{Only include if CARRIED-CONTEXT.md exists.}

Key decisions carried from previous milestones:
- {decision} (from Phase {N}, v{version})
...

## Key Constraints
{Only include if PROJECT.md exists and has requirements/constraints sections.}

**Must-have requirements:**
- {requirement}
...

**Technical constraints:**
- {constraint}
...

## Git Convention
Commit format: `{commit_prefix}({scope}): description`
Auto-commit: {auto_commit setting}
Commit granularity: {commit_per setting}

## GMSD Commands
Run `/gmsd:progress` to see the full project dashboard and recommended next action.
Run `/gmsd:quick` for small tasks outside the main workflow.
Run `/gmsd:sync` to manually regenerate this file.
```

### Step 5: Write the File

1. Create the `.claude/` directory in the project root if it does not exist.
2. Write the generated content to `.claude/CLAUDE.md`, overwriting any existing file.

### Step 6: Report (Optional)

If this workflow was invoked by `/gmsd:sync` (the manual command), report what was synced:

```
## CLAUDE.md Synced

Sections written:
- {list each section that was included, with a checkmark}
- {list each section that was omitted because data was missing, with an X}

File: .claude/CLAUDE.md
Size: {approximate line count} lines

Source files read:
- {list each file that was successfully read}
```

If this workflow was invoked as a post-command hook (automatic sync), do not display any output — the sync should be silent.
